// ─────────────────────────────────────────────────────────────────────────────
// Prisma Schema — Dates SaaS (Nail Salon Appointment Manager)
// ─────────────────────────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum Role {
  OWNER
  ADMIN
  MANICURIST
  RECEPTIONIST
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum NotificationType {
  CONFIRMATION
  REMINDER_24H
  CANCELLATION
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

// ─── Businesses (multi-tenant) ─────────────────────────────────────────────────

model Business {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId   String
  owner     User     @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // WhatsApp: one instance per business (Evolution instance name or Meta config)
  whatsappProvider       String?  // "evolution" | "meta"
  whatsappInstanceName    String? // Evolution: e.g. "empresa-1"
  metaPhoneNumberId      String?
  metaAccessToken        String?

  members       User[]       @relation("UserBusiness")
  manicurists   Manicurist[]
  clients       Client[]
  services      Service[]
  appSettings   AppSetting[]
  appointments  Appointment[]

  @@index([ownerId])
  @@index([slug])
}

// ─── Users & Auth ─────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          Role      @default(RECEPTIONIST)
  isActive      Boolean   @default(true)
  avatarUrl     String?
  businessId       String?
  business        Business?  @relation("UserBusiness", fields: [businessId], references: [id], onDelete: SetNull)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  sessions        Session[]
  manicurist      Manicurist?
  businessesOwned  Business[] @relation("BusinessOwner")

  @@index([email])
  @@index([role])
  @@index([businessId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

// ─── Manicurists ──────────────────────────────────────────────────────────────

model Manicurist {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bio         String?
  color       String    @default("#ec4899")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  schedules    Schedule[]
  blockedTimes BlockedTime[]
  appointments Appointment[]

  @@index([businessId])
  @@index([isActive])
}

// ─── Schedules (weekly availability) ─────────────────────────────────────────

model Schedule {
  id           String     @id @default(cuid())
  manicuristId String
  manicurist   Manicurist @relation(fields: [manicuristId], references: [id], onDelete: Cascade)
  // 0 = Sunday … 6 = Saturday
  dayOfWeek    Int
  startTime    String     // "09:00"
  endTime      String     // "18:00"
  isActive     Boolean    @default(true)

  @@unique([manicuristId, dayOfWeek])
  @@index([manicuristId])
}

// ─── Blocked Times (vacations, breaks) ───────────────────────────────────────

model BlockedTime {
  id           String     @id @default(cuid())
  manicuristId String
  manicurist   Manicurist @relation(fields: [manicuristId], references: [id], onDelete: Cascade)
  startAt      DateTime
  endAt        DateTime
  reason       String?
  createdAt    DateTime   @default(now())

  @@index([manicuristId, startAt, endAt])
}

// ─── Services ─────────────────────────────────────────────────────────────────

model Service {
  id          String    @id @default(cuid())
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name        String
  description String?
  duration    Int
  price       Decimal   @db.Decimal(10, 2)
  color       String    @default("#a855f7")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  appointments Appointment[]

  @@index([businessId])
  @@index([isActive])
}

// ─── Clients ──────────────────────────────────────────────────────────────────

model Client {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name       String
  phone      String   // E.164
  email      String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  appointments Appointment[]

  @@unique([businessId, phone])
  @@index([businessId])
  @@index([name])
}

// ─── Appointments ─────────────────────────────────────────────────────────────

model Appointment {
  id           String            @id @default(cuid())
  businessId   String
  business     Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  clientId     String
  client       Client           @relation(fields: [clientId], references: [id])
  manicuristId String
  manicurist   Manicurist       @relation(fields: [manicuristId], references: [id])
  serviceId    String
  service      Service          @relation(fields: [serviceId], references: [id])

  startAt     DateTime
  endAt       DateTime
  status      AppointmentStatus @default(PENDING)
  price       Decimal           @db.Decimal(10, 2)
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  notifications Notification[]

  @@index([businessId])
  @@index([manicuristId, startAt])
  @@index([clientId])
  @@index([startAt])
  @@index([status])
}

// ─── App settings (labels, copy, config) ──────────────────────────────────────

model AppSetting {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  key        String
  value      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, key])
  @@index([businessId])
}

// ─── Notifications ────────────────────────────────────────────────────────────

model Notification {
  id            String             @id @default(cuid())
  appointmentId String
  appointment   Appointment        @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  type          NotificationType
  status        NotificationStatus @default(PENDING)
  // WhatsApp message ID returned by provider
  externalId    String?
  error         String?
  scheduledFor  DateTime?
  sentAt        DateTime?
  createdAt     DateTime           @default(now())

  @@index([appointmentId])
  @@index([status, scheduledFor])
  @@index([type])
}
